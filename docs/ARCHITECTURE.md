# 🏗️ АРХІТЕКТУРА АВТЕНТИФІКАЦІЇ

## Потік Автентифікації

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         КОРИСТУВАЧ                                       │
└──────────────────────────────┬──────────────────────────────────────────┘
                               │
                    Відкриває http://localhost:5173
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   FRONTEND (React)                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  App.jsx                                                        │   │
│  │  - Перевіряє: isAuthenticated?                                 │   │
│  │  - ДА → показує Календар                                       │   │
│  │  - НІ → показує Welcome page                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                          │
│                    Перший раз? НІ токена?                               │
│                               │                                          │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Welcome Page (Login/Signup)                                    │   │
│  │                                                                 │   │
│  │  ┌──────────────────┐           ┌──────────────────┐           │   │
│  │  │   LOGIN FORM     │           │  SIGNUP FORM     │           │   │
│  │  ├──────────────────┤           ├──────────────────┤           │   │
│  │  │ Email      ____  │           │ Email      ____  │           │   │
│  │  │ Password   ____  │           │ Name       ____  │           │   │
│  │  │ [Увійти]        │           │ Password   ____  │           │   │
│  │  └──────────────────┘           │ Confirm    ____  │           │   │
│  │                                 │ [Реєстрація]    │           │   │
│  │                                 └──────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                          │
│         Натисує Login або Sign Up                                       │
│                               │                                          │
│               ┌───────────────┴───────────────┐                         │
│               ▼                               ▼                         │
│       axios.post(...)                   axios.post(...)                │
│       /auth/login                       /auth/signup                   │
│               │                               │                         │
└───────────────┼───────────────────────────────┼──────────────────────────┘
                │                               │
                │    HTTP REQUEST               │
                │                               │
                ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   BACKEND (FastAPI)                                      │
│                                                                         │
│  ┌──────────────────────────┐      ┌──────────────────────────┐       │
│  │  POST /auth/login        │      │  POST /auth/signup       │       │
│  ├──────────────────────────┤      ├──────────────────────────┤       │
│  │ 1. Отримати email+pass   │      │ 1. Отримати email+pass   │       │
│  │ 2. Знайти юзера по email │      │ 2. Перевірити email      │       │
│  │ 3. Перевірити пароль     │      │    (unique?)              │       │
│  │ 4. Якщо OK:              │      │ 3. Захешувати пароль     │       │
│  │    - Створити JWT        │      │ 4. Створити юзера в БД   │       │
│  │    - Повернути токен     │      │ 5. Створити JWT          │       │
│  │ 5. Якщо помилка:         │      │ 6. Повернути токен       │       │
│  │    - Повернути 401       │      │ 7. Якщо помилка:         │       │
│  │                          │      │    - Повернути 400       │       │
│  └──────────────────────────┘      └──────────────────────────┘       │
│                │                              │                        │
│         ┌──────┴──────────────────────────────┴─────┐                 │
│         │ Перевірка в БД (PostgreSQL)               │                 │
│         │ - Пошук користувача                       │                 │
│         │ - Хеширування пароля (bcrypt)            │                 │
│         │ - Вставка нового користувача              │                 │
│         └──────────────────────────────────────────┘                 │
│                        │                                              │
│                        ▼                                              │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │  Створення JWT TOKEN                                          │   │
│  │  ┌──────────────────┬─────────────────┬──────────────────────┐ │   │
│  │  │  HEADER          │  PAYLOAD        │  SIGNATURE           │ │   │
│  │  ├──────────────────┼─────────────────┼──────────────────────┤ │   │
│  │  │{                 │{                │ HMACSHA256(          │ │   │
│  │  │  alg: HS256      │  sub: email     │   base64(header)+    │ │   │
│  │  │  typ: JWT        │  exp: timestamp │   base64(payload),   │ │   │
│  │  │}                 │}                │   SECRET_KEY         │ │   │
│  │  │                  │                 │ )                    │ │   │
│  │  └──────────────────┴─────────────────┴──────────────────────┘ │   │
│  │                                                                 │   │
│  │  Дійсний 7 днів від створення                                 │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                        │                                              │
└────────────────────────┼──────────────────────────────────────────────┘
                         │
            JSON Response з JWT Token
                         │
         {"access_token": "eyJhbGc...", "token_type": "bearer"}
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   FRONTEND (React)                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  AuthContext.js                                                 │   │
│  │                                                                 │   │
│  │  1. Отримати токен з відповіді                                 │   │
│  │  2. Зберегти в localStorage:                                   │   │
│  │     localStorage.setItem('access_token', token)               │   │
│  │  3. Зберегти дані користувача                                  │   │
│  │  4. Встановити isAuthenticated = true                          │   │
│  │  5. Перенаправити на календар                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                        │                                               │
└────────────────────────┼───────────────────────────────────────────────┘
                         │
                    useNavigate('/')
                         │
                         ▼
                  ┌──────────────┐
                  │  КАЛЕНДАР    │
                  │  📅📅📅     │
                  └──────────────┘


```

## Захищені Endpoint Потік

```
┌──────────────────────────────────────────────────────────────────────┐
│                КОРИСТУВАЧ НАТИСКАЄ "ОТРИМАТИ СТУДЕНТІВ"              │
└───────────────────────────┬──────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                   FRONTEND (React)                                    │
│                                                                      │
│  const { apiClient } = useAuth();                                   │
│  const response = apiClient.get('/students/');                      │
│                                                                      │
│  Axios INTERCEPTOR додає токен:                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  GET /students/                                            │    │
│  │  Header:                                                   │    │
│  │    Authorization: Bearer eyJhbGc...                        │    │
│  └────────────────────────────────────────────────────────────┘    │
└───────────────┬────────────────────────────────────────────────────┘
                │
        HTTP REQUEST з токеном
                │
                ▼
┌──────────────────────────────────────────────────────────────────────┐
│                   BACKEND (FastAPI)                                   │
│                                                                      │
│  @app.get("/students/")                                             │
│  def read_students(                                                 │
│    session: Session = Depends(get_session),                         │
│    current_user: User = Depends(get_current_active_user)  ← ТУТ!   │
│  ):                                                                 │
│                                                                      │
│  MIDDLEWARE: get_current_active_user()                              │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  1. Отримати токен з заголовку Authorization              │    │
│  │  2. Декодувати JWT (перевірити підпис)                   │    │
│  │  3. Витягнути email з payload                             │    │
│  │  4. Знайти користувача в БД                               │    │
│  │  5. Перевірити is_active = true                           │    │
│  │  6. Якщо все OK → продовжити                              │    │
│  │  7. Якщо помилка → повернути 401 Unauthorized            │    │
│  └────────────────────────────────────────────────────────────┘    │
│                        │                                            │
│              ┌─────────┴─────────┐                                  │
│              ▼                   ▼                                   │
│        Успіх ✅              Помилка ❌                             │
│                │                   │                                │
│         Повернути список      Повернути 401                        │
│         студентів                                                   │
│         [                   HTTPException(                         │
│           {id, name, ...}     status=401,                         │
│           ...                 detail="Could not                   │
│         ]                      validate credentials"             │
│                                )                                   │
└────────────────────────────┬────────┬────────────────────────────────┘
                             │        │
                             ▼        ▼
┌──────────────────────┐  ┌──────────────────────┐
│  JSON Response       │  │  JSON Error          │
│  [                   │  │  {                   │
│    {                 │  │    "detail": "Could  │
│      "id": "uuid",   │  │    not validate..."  │
│      "name": "Іван"  │  │  }                   │
│    }                 │  │                      │
│  ]                   │  │  Status: 401         │
└────────┬─────────────┘  └────┬─────────────────┘
         │                    │
         │ FRONTEND           │ FRONTEND
         │ Axios Response     │ Axios Error
         │                    │
         ▼                    ▼
    Показувати         Автоматично:
    список             1. Видалити токен
    студентів          2. Видалити дані юзера
                       3. Перенаправити на Welcome
```

## Структура localStorage

```
┌─────────────────────────────────────────────────────┐
│            FRONTEND localStorage                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Key: access_token                                  │
│  Value: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...    │
│  Дійсний: 7 днів                                    │
│                                                     │
│  Key: user                                          │
│  Value: {                                           │
│    "id": "550e8400-e29b-41d4-a716-446655440000",  │
│    "email": "teacher@example.com",                 │
│    "name": "Іван Петренко",                        │
│    "is_active": true,                              │
│    "created_at": "2026-01-14T10:30:00+02:00"      │
│  }                                                  │
│                                                     │
└─────────────────────────────────────────────────────┘

При LOGOUT:
  localStorage.removeItem('access_token')
  localStorage.removeItem('user')
  → Користувач перенаправляється на Welcome page

При ПОМИЛЦІ 401:
  Автоматично видаляються обидва ключи
  → Користувач видить Welcome page
  → Потребує повторної реєстрації
```

## JWT Токен Структура

```
┌──────────────────────────────────────────────────────────────────┐
│                      JWT Token                                    │
│                                                                  │
│  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.               ← HEADER   │
│  eyJzdWIiOiJ0ZWFjaGVyQGV4YW1wbGUuY29tIiwiZXhwIjoxNzIzMDg0ODAwfQ. │
│                                                      ← PAYLOAD  │
│  xxx...xxx                                           ← SIGNATURE│
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  HEADER (базе64 декодовано):                                     │
│  {                                                               │
│    "alg": "HS256",      ← Алгоритм                              │
│    "typ": "JWT"        ← Тип                                     │
│  }                                                               │
├──────────────────────────────────────────────────────────────────┤
│  PAYLOAD (базе64 декодовано):                                    │
│  {                                                               │
│    "sub": "teacher@example.com",  ← Від кого (email)           │
│    "exp": 1723084800              ← До коли (timestamp)         │
│  }                                                               │
├──────────────────────────────────────────────────────────────────┤
│  SIGNATURE:                                                      │
│  HMACSHA256(                                                     │
│    base64(header) + "." + base64(payload),                      │
│    "SECRET_KEY"                                                 │
│  )                                                               │
│                                                                  │
│  Використовується для перевірки що токен не був змінений        │
└──────────────────────────────────────────────────────────────────┘

Часова шкала:
  Створено:  2026-01-14 10:30:00
  Закінчується: 2026-01-21 10:30:00 (7 днів пізніше)
  Якщо спробувати використати після цього:
  → Помилка 401 Unauthorized
  → Потреба повторної реєстрації
```

## API Endpoints Таблиця

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПУБЛІЧНІ ENDPOINTS                           │
├─────────────────────────────────────────────────────────────────┤
│  POST /auth/signup                                              │
│  POST /auth/login                                               │
│  Не потребують токена!                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  ЗАХИЩЕНІ ENDPOINTS                             │
├────────────────────────────────┬──────────────────────────────┤
│  CATEGORY      │  ENDPOINT                                     │
├────────────────┼──────────────────────────────────────────────┤
│  Auth          │  GET    /auth/me                             │
│                │                                              │
│  Students      │  GET    /students/                           │
│                │  POST   /students/                           │
│                │  PATCH  /students/{id}                       │
│                │  GET    /students/{slug}                     │
│                │                                              │
│  Lessons       │  GET    /lessons/                            │
│                │  POST   /lessons/                            │
│                │  PATCH  /lessons/{id}                        │
│                │  PATCH  /lessons/series/{id}                 │
│                │                                              │
│  Payments      │  POST   /payments/                           │
│                │  GET    /payments/student/{id}               │
│                │                                              │
│  Upload        │  POST   /upload/                             │
│                │                                              │
│ Всі потребують:                                              │
│ Header: Authorization: Bearer <token>                         │
└────────────────┴──────────────────────────────────────────────┘
```

---

**Це полна архітектура IvolTutor автентифікації! 🏗️**
